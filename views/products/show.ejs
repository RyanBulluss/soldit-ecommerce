<%- include('../partials/header') %>
<%- include('../partials/title') %>

<image class="show-image" src="https://img.freepik.com/premium-photo/white-tshirt-white-background-front-back-view-generative-ai_446633-7047.jpg?w=740"></image><br>
<%= product.name %> <br>
<% const ratingsAverage = product.reviews.reduce((acc, review) => acc + review.rating, 0) / product.reviews.length %>

Rating: <%= ratingsAverage ? ratingsAverage : 'No ratings' %> <br>
Â£<%= product.price %> <br>
Quality: <%= product.quality %> <br>
Category: <%= product.category %> <br>
Stock: <%= product.quantity %> <br> 
<form action="<%= product._id %>/add" method="POST">
    <label>Quantity:</label>
    <input name="quantity" value="1" min="1" max="<%= product.quantity %>" type="number"> <br>
    <button class="mx-auto btn mt-1 btn-primary">Add To Basket</button>
</form><br>

Seller: <%= product.userName %> <br>


<% if(user?.name == product.userName) { %>
    <form action="<%= product._id %>/delete?_method=DELETE" method="POST">
        <button type="submit" class="mx-auto btn mt-3 btn-danger">Delete Product</button>
    </form>
<% } %>

<% if(product.reviews.length) { %>
<h4>Reviews:</h4>
<table>
    <tbody>
        <% product.reviews.forEach(function(review) { %>
            <tr> 
                <td><image src="<%= review.userAvatar %>" referrerpolicy="no-referrer"></image></td>
                <td><%= review.userName %></td>
                <td><%= review.rating %></td>
                <td><%= review.review %></td>
                <td>00/00/00</td>
                <td>
                    <% if(user?._id.equals(review.user)) { %>
                        <form action="<%= review._id %>?_method=DELETE" method="POST">
                            <button type="submit" class="btn btn-danger">X</button>
                        </form>
                    <% } %>
                </td>
            </tr>
        <% }) %>
    </tbody>
</table>
<% } else { %>
    <h5>No Reviews Yet</h5>
<% } %>
<% if (user) { %>
    <a href="<%- product.id %>-new-review">New Review</a>
<% } %>


<%- include('../partials/footer') %>